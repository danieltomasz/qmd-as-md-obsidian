'use strict';

var obsidian = require('obsidian');
var child_process = require('child_process');
var path = require('path');

function _interopNamespaceDefault(e) {
    var n = Object.create(null);
    if (e) {
        Object.keys(e).forEach(function (k) {
            if (k !== 'default') {
                var d = Object.getOwnPropertyDescriptor(e, k);
                Object.defineProperty(n, k, d.get ? d : {
                    enumerable: true,
                    get: function () { return e[k]; }
                });
            }
        });
    }
    n.default = e;
    return Object.freeze(n);
}

var path__namespace = /*#__PURE__*/_interopNamespaceDefault(path);

const DEFAULT_SETTINGS = {
    quartoPath: 'quarto', // Default to global quarto installation
    autoPreview: false
};
class QmdAsMdPlugin extends obsidian.Plugin {
    constructor() {
        super(...arguments);
        this.activePreviewProcesses = new Map();
    }
    async onload() {
        await this.loadSettings();
        // Register qmd files as markdown (existing functionality)
        this.registerExtensions(["qmd"], "markdown");
        // Add settings tab
        this.addSettingTab(new QmdSettingTab(this.app, this));
        // Add ribbon icon for quick preview toggle
        this.addRibbonIcon('eye', 'Toggle Quarto Preview', (evt) => {
            const activeView = this.app.workspace.getActiveViewOfType(obsidian.MarkdownView);
            if (activeView?.file && this.isQuartoFile(activeView.file)) {
                this.togglePreview(activeView.file);
            }
            else {
                new obsidian.Notice('Current file is not a Quarto document');
            }
        });
        // Add command to toggle preview
        this.addCommand({
            id: 'toggle-quarto-preview',
            name: 'Toggle Quarto Preview',
            callback: () => {
                const activeView = this.app.workspace.getActiveViewOfType(obsidian.MarkdownView);
                if (activeView?.file && this.isQuartoFile(activeView.file)) {
                    this.togglePreview(activeView.file);
                }
                else {
                    new obsidian.Notice('Current file is not a Quarto document');
                }
            },
            hotkeys: [{ modifiers: ['Ctrl', 'Shift'], key: 'p' }]
        });
        // Add command to stop all previews
        this.addCommand({
            id: 'stop-all-quarto-previews',
            name: 'Stop All Quarto Previews',
            callback: () => {
                this.stopAllPreviews();
            }
        });
        // Register event handlers
        this.registerEvent(this.app.workspace.on('active-leaf-change', (leaf) => {
            if (this.settings.autoPreview && leaf?.view instanceof obsidian.MarkdownView) {
                const file = leaf.view.file;
                if (file && this.isQuartoFile(file)) {
                    this.startPreview(file);
                }
            }
        }));
    }
    onunload() {
        this.stopAllPreviews();
    }
    async loadSettings() {
        this.settings = Object.assign({}, DEFAULT_SETTINGS, await this.loadData());
    }
    async saveSettings() {
        await this.saveData(this.settings);
    }
    isQuartoFile(file) {
        return file.extension === 'qmd';
    }
    async togglePreview(file) {
        if (this.activePreviewProcesses.has(file.path)) {
            await this.stopPreview(file);
        }
        else {
            await this.startPreview(file);
        }
    }
    async startPreview(file) {
        if (this.activePreviewProcesses.has(file.path)) {
            return; // Preview already running
        }
        try {
            const adapter = this.app.vault.adapter;
            const filePath = adapter.getFullPath(file.path);
            const workingDir = path__namespace.dirname(filePath);
            const process = child_process.spawn(this.settings.quartoPath, ['preview', file.path], {
                cwd: workingDir,
                shell: true
            });
            let previewUrl = null;
            process.stdout?.on('data', (data) => {
                const output = data.toString();
                console.log(`Quarto Preview Output: ${output}`);
                // Extract preview URL if available
                if (output.includes('Browse at')) {
                    const match = output.match(/Browse at\s+(http:\/\/[^\s]+)/);
                    if (match && match[1]) {
                        previewUrl = match[1];
                        new obsidian.Notice(`Preview available at ${previewUrl}`);
                    }
                }
            });
            process.stderr?.on('data', (data) => {
                console.error(`Quarto Preview Error: ${data}`);
                new obsidian.Notice(`Quarto Preview Error: ${data}`);
            });
            process.on('close', (code) => {
                if (code !== null && code !== 0) {
                    new obsidian.Notice(`Quarto preview process exited with code ${code}`);
                }
                this.activePreviewProcesses.delete(file.path);
            });
            this.activePreviewProcesses.set(file.path, process);
            new obsidian.Notice('Quarto preview started');
        }
        catch (error) {
            console.error('Failed to start Quarto preview:', error);
            new obsidian.Notice('Failed to start Quarto preview');
        }
    }
    async stopPreview(file) {
        const process = this.activePreviewProcesses.get(file.path);
        if (process) {
            process.kill();
            this.activePreviewProcesses.delete(file.path);
            new obsidian.Notice('Quarto preview stopped');
        }
    }
    stopAllPreviews() {
        // Convert Map entries to array before iterating
        Array.from(this.activePreviewProcesses.entries()).forEach(([filePath, process]) => {
            process.kill();
            this.activePreviewProcesses.delete(filePath);
        });
        if (this.activePreviewProcesses.size > 0) {
            new obsidian.Notice('All Quarto previews stopped');
        }
    }
}
class QmdSettingTab extends obsidian.PluginSettingTab {
    constructor(app, plugin) {
        super(app, plugin);
        this.plugin = plugin;
    }
    display() {
        const { containerEl } = this;
        containerEl.empty();
        containerEl.createEl('h2', { text: 'Quarto Preview Settings' });
        new obsidian.Setting(containerEl)
            .setName('Quarto Path')
            .setDesc('Path to Quarto executable (e.g., quarto, /usr/local/bin/quarto)')
            .addText(text => text
            .setPlaceholder('quarto')
            .setValue(this.plugin.settings.quartoPath)
            .onChange(async (value) => {
            this.plugin.settings.quartoPath = value;
            await this.plugin.saveSettings();
        }));
        new obsidian.Setting(containerEl)
            .setName('Auto Preview')
            .setDesc('Automatically start preview when opening Quarto files')
            .addToggle(toggle => toggle
            .setValue(this.plugin.settings.autoPreview)
            .onChange(async (value) => {
            this.plugin.settings.autoPreview = value;
            await this.plugin.saveSettings();
        }));
        containerEl.createEl('h3', { text: 'Usage' });
        const usageText = containerEl.createEl('p');
        usageText.innerHTML = `
            - Use the ribbon icon or command palette to toggle preview<br>
            - Ctrl+Shift+P to quickly toggle preview<br>
            - Preview URLs will be shown in notifications<br>
            - Auto-preview can be enabled to start preview automatically
        `;
    }
}

module.exports = QmdAsMdPlugin;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibWFpbi5qcyIsInNvdXJjZXMiOlsic3JjL21haW4udHMiXSwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgUGx1Z2luLCBOb3RpY2UsIFRGaWxlLCBNYXJrZG93blZpZXcsIFBsdWdpblNldHRpbmdUYWIsIEFwcCwgU2V0dGluZywgV29ya3NwYWNlTGVhZiB9IGZyb20gJ29ic2lkaWFuJztcbmltcG9ydCB7IHNwYXduLCBDaGlsZFByb2Nlc3MgfSBmcm9tICdjaGlsZF9wcm9jZXNzJztcbmltcG9ydCAqIGFzIHBhdGggZnJvbSAncGF0aCc7XG5cbmludGVyZmFjZSBRbWRQbHVnaW5TZXR0aW5ncyB7XG4gICAgcXVhcnRvUGF0aDogc3RyaW5nO1xuICAgIGF1dG9QcmV2aWV3OiBib29sZWFuO1xufVxuXG5jb25zdCBERUZBVUxUX1NFVFRJTkdTOiBRbWRQbHVnaW5TZXR0aW5ncyA9IHtcbiAgICBxdWFydG9QYXRoOiAncXVhcnRvJywgLy8gRGVmYXVsdCB0byBnbG9iYWwgcXVhcnRvIGluc3RhbGxhdGlvblxuICAgIGF1dG9QcmV2aWV3OiBmYWxzZVxufVxuXG5leHBvcnQgZGVmYXVsdCBjbGFzcyBRbWRBc01kUGx1Z2luIGV4dGVuZHMgUGx1Z2luIHtcbiAgICBzZXR0aW5nczogUW1kUGx1Z2luU2V0dGluZ3M7XG4gICAgYWN0aXZlUHJldmlld1Byb2Nlc3NlczogTWFwPHN0cmluZywgQ2hpbGRQcm9jZXNzPiA9IG5ldyBNYXAoKTtcblxuICAgIGFzeW5jIG9ubG9hZCgpIHtcbiAgICAgICAgYXdhaXQgdGhpcy5sb2FkU2V0dGluZ3MoKTtcblxuICAgICAgICAvLyBSZWdpc3RlciBxbWQgZmlsZXMgYXMgbWFya2Rvd24gKGV4aXN0aW5nIGZ1bmN0aW9uYWxpdHkpXG4gICAgICAgIHRoaXMucmVnaXN0ZXJFeHRlbnNpb25zKFtcInFtZFwiXSwgXCJtYXJrZG93blwiKTtcblxuICAgICAgICAvLyBBZGQgc2V0dGluZ3MgdGFiXG4gICAgICAgIHRoaXMuYWRkU2V0dGluZ1RhYihuZXcgUW1kU2V0dGluZ1RhYih0aGlzLmFwcCwgdGhpcykpO1xuXG4gICAgICAgIC8vIEFkZCByaWJib24gaWNvbiBmb3IgcXVpY2sgcHJldmlldyB0b2dnbGVcbiAgICAgICAgY29uc3QgcmliYm9uSWNvbkVsID0gdGhpcy5hZGRSaWJib25JY29uKCdleWUnLCAnVG9nZ2xlIFF1YXJ0byBQcmV2aWV3JywgKGV2dCkgPT4ge1xuICAgICAgICAgICAgY29uc3QgYWN0aXZlVmlldyA9IHRoaXMuYXBwLndvcmtzcGFjZS5nZXRBY3RpdmVWaWV3T2ZUeXBlKE1hcmtkb3duVmlldyk7XG4gICAgICAgICAgICBpZiAoYWN0aXZlVmlldz8uZmlsZSAmJiB0aGlzLmlzUXVhcnRvRmlsZShhY3RpdmVWaWV3LmZpbGUpKSB7XG4gICAgICAgICAgICAgICAgdGhpcy50b2dnbGVQcmV2aWV3KGFjdGl2ZVZpZXcuZmlsZSk7XG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgIG5ldyBOb3RpY2UoJ0N1cnJlbnQgZmlsZSBpcyBub3QgYSBRdWFydG8gZG9jdW1lbnQnKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfSk7XG5cbiAgICAgICAgLy8gQWRkIGNvbW1hbmQgdG8gdG9nZ2xlIHByZXZpZXdcbiAgICAgICAgdGhpcy5hZGRDb21tYW5kKHtcbiAgICAgICAgICAgIGlkOiAndG9nZ2xlLXF1YXJ0by1wcmV2aWV3JyxcbiAgICAgICAgICAgIG5hbWU6ICdUb2dnbGUgUXVhcnRvIFByZXZpZXcnLFxuICAgICAgICAgICAgY2FsbGJhY2s6ICgpID0+IHtcbiAgICAgICAgICAgICAgICBjb25zdCBhY3RpdmVWaWV3ID0gdGhpcy5hcHAud29ya3NwYWNlLmdldEFjdGl2ZVZpZXdPZlR5cGUoTWFya2Rvd25WaWV3KTtcbiAgICAgICAgICAgICAgICBpZiAoYWN0aXZlVmlldz8uZmlsZSAmJiB0aGlzLmlzUXVhcnRvRmlsZShhY3RpdmVWaWV3LmZpbGUpKSB7XG4gICAgICAgICAgICAgICAgICAgIHRoaXMudG9nZ2xlUHJldmlldyhhY3RpdmVWaWV3LmZpbGUpO1xuICAgICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgIG5ldyBOb3RpY2UoJ0N1cnJlbnQgZmlsZSBpcyBub3QgYSBRdWFydG8gZG9jdW1lbnQnKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9LFxuICAgICAgICAgICAgaG90a2V5czogW3sgbW9kaWZpZXJzOiBbJ0N0cmwnLCAnU2hpZnQnXSwga2V5OiAncCcgfV1cbiAgICAgICAgfSk7XG5cbiAgICAgICAgLy8gQWRkIGNvbW1hbmQgdG8gc3RvcCBhbGwgcHJldmlld3NcbiAgICAgICAgdGhpcy5hZGRDb21tYW5kKHtcbiAgICAgICAgICAgIGlkOiAnc3RvcC1hbGwtcXVhcnRvLXByZXZpZXdzJyxcbiAgICAgICAgICAgIG5hbWU6ICdTdG9wIEFsbCBRdWFydG8gUHJldmlld3MnLFxuICAgICAgICAgICAgY2FsbGJhY2s6ICgpID0+IHtcbiAgICAgICAgICAgICAgICB0aGlzLnN0b3BBbGxQcmV2aWV3cygpO1xuICAgICAgICAgICAgfVxuICAgICAgICB9KTtcblxuICAgICAgICAvLyBSZWdpc3RlciBldmVudCBoYW5kbGVyc1xuICAgICAgICB0aGlzLnJlZ2lzdGVyRXZlbnQoXG4gICAgICAgICAgICB0aGlzLmFwcC53b3Jrc3BhY2Uub24oJ2FjdGl2ZS1sZWFmLWNoYW5nZScsIChsZWFmOiBXb3Jrc3BhY2VMZWFmIHwgbnVsbCkgPT4ge1xuICAgICAgICAgICAgICAgIGlmICh0aGlzLnNldHRpbmdzLmF1dG9QcmV2aWV3ICYmIGxlYWY/LnZpZXcgaW5zdGFuY2VvZiBNYXJrZG93blZpZXcpIHtcbiAgICAgICAgICAgICAgICAgICAgY29uc3QgZmlsZSA9IGxlYWYudmlldy5maWxlO1xuICAgICAgICAgICAgICAgICAgICBpZiAoZmlsZSAmJiB0aGlzLmlzUXVhcnRvRmlsZShmaWxlKSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5zdGFydFByZXZpZXcoZmlsZSk7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9KVxuICAgICAgICApO1xuICAgIH1cblxuICAgIG9udW5sb2FkKCkge1xuICAgICAgICB0aGlzLnN0b3BBbGxQcmV2aWV3cygpO1xuICAgIH1cblxuICAgIGFzeW5jIGxvYWRTZXR0aW5ncygpIHtcbiAgICAgICAgdGhpcy5zZXR0aW5ncyA9IE9iamVjdC5hc3NpZ24oe30sIERFRkFVTFRfU0VUVElOR1MsIGF3YWl0IHRoaXMubG9hZERhdGEoKSk7XG4gICAgfVxuXG4gICAgYXN5bmMgc2F2ZVNldHRpbmdzKCkge1xuICAgICAgICBhd2FpdCB0aGlzLnNhdmVEYXRhKHRoaXMuc2V0dGluZ3MpO1xuICAgIH1cblxuICAgIGlzUXVhcnRvRmlsZShmaWxlOiBURmlsZSk6IGJvb2xlYW4ge1xuICAgICAgICByZXR1cm4gZmlsZS5leHRlbnNpb24gPT09ICdxbWQnO1xuICAgIH1cblxuICAgIGFzeW5jIHRvZ2dsZVByZXZpZXcoZmlsZTogVEZpbGUpIHtcbiAgICAgICAgaWYgKHRoaXMuYWN0aXZlUHJldmlld1Byb2Nlc3Nlcy5oYXMoZmlsZS5wYXRoKSkge1xuICAgICAgICAgICAgYXdhaXQgdGhpcy5zdG9wUHJldmlldyhmaWxlKTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIGF3YWl0IHRoaXMuc3RhcnRQcmV2aWV3KGZpbGUpO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgYXN5bmMgc3RhcnRQcmV2aWV3KGZpbGU6IFRGaWxlKSB7XG4gICAgICAgIGlmICh0aGlzLmFjdGl2ZVByZXZpZXdQcm9jZXNzZXMuaGFzKGZpbGUucGF0aCkpIHtcbiAgICAgICAgICAgIHJldHVybjsgLy8gUHJldmlldyBhbHJlYWR5IHJ1bm5pbmdcbiAgICAgICAgfVxuXG4gICAgICAgIHRyeSB7XG4gICAgICAgICAgICBjb25zdCBhZGFwdGVyID0gdGhpcy5hcHAudmF1bHQuYWRhcHRlcjtcbiAgICAgICAgICAgIGNvbnN0IGZpbGVQYXRoID0gKGFkYXB0ZXIgYXMgYW55KS5nZXRGdWxsUGF0aChmaWxlLnBhdGgpO1xuICAgICAgICAgICAgY29uc3Qgd29ya2luZ0RpciA9IHBhdGguZGlybmFtZShmaWxlUGF0aCk7XG5cbiAgICAgICAgICAgIGNvbnN0IHByb2Nlc3MgPSBzcGF3bih0aGlzLnNldHRpbmdzLnF1YXJ0b1BhdGgsIFsncHJldmlldycsIGZpbGUucGF0aF0sIHtcbiAgICAgICAgICAgICAgICBjd2Q6IHdvcmtpbmdEaXIsXG4gICAgICAgICAgICAgICAgc2hlbGw6IHRydWVcbiAgICAgICAgICAgIH0pO1xuXG4gICAgICAgICAgICBsZXQgcHJldmlld1VybDogc3RyaW5nIHwgbnVsbCA9IG51bGw7XG5cbiAgICAgICAgICAgIHByb2Nlc3Muc3Rkb3V0Py5vbignZGF0YScsIChkYXRhOiBCdWZmZXIpID0+IHtcbiAgICAgICAgICAgICAgICBjb25zdCBvdXRwdXQgPSBkYXRhLnRvU3RyaW5nKCk7XG4gICAgICAgICAgICAgICAgY29uc29sZS5sb2coYFF1YXJ0byBQcmV2aWV3IE91dHB1dDogJHtvdXRwdXR9YCk7XG4gICAgICAgICAgICAgICAgXG4gICAgICAgICAgICAgICAgLy8gRXh0cmFjdCBwcmV2aWV3IFVSTCBpZiBhdmFpbGFibGVcbiAgICAgICAgICAgICAgICBpZiAob3V0cHV0LmluY2x1ZGVzKCdCcm93c2UgYXQnKSkge1xuICAgICAgICAgICAgICAgICAgICBjb25zdCBtYXRjaCA9IG91dHB1dC5tYXRjaCgvQnJvd3NlIGF0XFxzKyhodHRwOlxcL1xcL1teXFxzXSspLyk7XG4gICAgICAgICAgICAgICAgICAgIGlmIChtYXRjaCAmJiBtYXRjaFsxXSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgcHJldmlld1VybCA9IG1hdGNoWzFdO1xuICAgICAgICAgICAgICAgICAgICAgICAgbmV3IE5vdGljZShgUHJldmlldyBhdmFpbGFibGUgYXQgJHtwcmV2aWV3VXJsfWApO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfSk7XG5cbiAgICAgICAgICAgIHByb2Nlc3Muc3RkZXJyPy5vbignZGF0YScsIChkYXRhOiBCdWZmZXIpID0+IHtcbiAgICAgICAgICAgICAgICBjb25zb2xlLmVycm9yKGBRdWFydG8gUHJldmlldyBFcnJvcjogJHtkYXRhfWApO1xuICAgICAgICAgICAgICAgIG5ldyBOb3RpY2UoYFF1YXJ0byBQcmV2aWV3IEVycm9yOiAke2RhdGF9YCk7XG4gICAgICAgICAgICB9KTtcblxuICAgICAgICAgICAgcHJvY2Vzcy5vbignY2xvc2UnLCAoY29kZTogbnVtYmVyIHwgbnVsbCkgPT4ge1xuICAgICAgICAgICAgICAgIGlmIChjb2RlICE9PSBudWxsICYmIGNvZGUgIT09IDApIHtcbiAgICAgICAgICAgICAgICAgICAgbmV3IE5vdGljZShgUXVhcnRvIHByZXZpZXcgcHJvY2VzcyBleGl0ZWQgd2l0aCBjb2RlICR7Y29kZX1gKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgdGhpcy5hY3RpdmVQcmV2aWV3UHJvY2Vzc2VzLmRlbGV0ZShmaWxlLnBhdGgpO1xuICAgICAgICAgICAgfSk7XG5cbiAgICAgICAgICAgIHRoaXMuYWN0aXZlUHJldmlld1Byb2Nlc3Nlcy5zZXQoZmlsZS5wYXRoLCBwcm9jZXNzKTtcbiAgICAgICAgICAgIG5ldyBOb3RpY2UoJ1F1YXJ0byBwcmV2aWV3IHN0YXJ0ZWQnKTtcblxuICAgICAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgICAgICAgY29uc29sZS5lcnJvcignRmFpbGVkIHRvIHN0YXJ0IFF1YXJ0byBwcmV2aWV3OicsIGVycm9yKTtcbiAgICAgICAgICAgIG5ldyBOb3RpY2UoJ0ZhaWxlZCB0byBzdGFydCBRdWFydG8gcHJldmlldycpO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgYXN5bmMgc3RvcFByZXZpZXcoZmlsZTogVEZpbGUpIHtcbiAgICAgICAgY29uc3QgcHJvY2VzcyA9IHRoaXMuYWN0aXZlUHJldmlld1Byb2Nlc3Nlcy5nZXQoZmlsZS5wYXRoKTtcbiAgICAgICAgaWYgKHByb2Nlc3MpIHtcbiAgICAgICAgICAgIHByb2Nlc3Mua2lsbCgpO1xuICAgICAgICAgICAgdGhpcy5hY3RpdmVQcmV2aWV3UHJvY2Vzc2VzLmRlbGV0ZShmaWxlLnBhdGgpO1xuICAgICAgICAgICAgbmV3IE5vdGljZSgnUXVhcnRvIHByZXZpZXcgc3RvcHBlZCcpO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgc3RvcEFsbFByZXZpZXdzKCkge1xuICAgICAgICAvLyBDb252ZXJ0IE1hcCBlbnRyaWVzIHRvIGFycmF5IGJlZm9yZSBpdGVyYXRpbmdcbiAgICAgICAgQXJyYXkuZnJvbSh0aGlzLmFjdGl2ZVByZXZpZXdQcm9jZXNzZXMuZW50cmllcygpKS5mb3JFYWNoKChbZmlsZVBhdGgsIHByb2Nlc3NdKSA9PiB7XG4gICAgICAgICAgICBwcm9jZXNzLmtpbGwoKTtcbiAgICAgICAgICAgIHRoaXMuYWN0aXZlUHJldmlld1Byb2Nlc3Nlcy5kZWxldGUoZmlsZVBhdGgpO1xuICAgICAgICB9KTtcbiAgICAgICAgaWYgKHRoaXMuYWN0aXZlUHJldmlld1Byb2Nlc3Nlcy5zaXplID4gMCkge1xuICAgICAgICAgICAgbmV3IE5vdGljZSgnQWxsIFF1YXJ0byBwcmV2aWV3cyBzdG9wcGVkJyk7XG4gICAgICAgIH1cbiAgICB9XG59XG5cbmNsYXNzIFFtZFNldHRpbmdUYWIgZXh0ZW5kcyBQbHVnaW5TZXR0aW5nVGFiIHtcbiAgICBwbHVnaW46IFFtZEFzTWRQbHVnaW47XG5cbiAgICBjb25zdHJ1Y3RvcihhcHA6IEFwcCwgcGx1Z2luOiBRbWRBc01kUGx1Z2luKSB7XG4gICAgICAgIHN1cGVyKGFwcCwgcGx1Z2luKTtcbiAgICAgICAgdGhpcy5wbHVnaW4gPSBwbHVnaW47XG4gICAgfVxuXG4gICAgZGlzcGxheSgpOiB2b2lkIHtcbiAgICAgICAgY29uc3QgeyBjb250YWluZXJFbCB9ID0gdGhpcztcbiAgICAgICAgY29udGFpbmVyRWwuZW1wdHkoKTtcblxuICAgICAgICBjb250YWluZXJFbC5jcmVhdGVFbCgnaDInLCB7IHRleHQ6ICdRdWFydG8gUHJldmlldyBTZXR0aW5ncycgfSk7XG5cbiAgICAgICAgbmV3IFNldHRpbmcoY29udGFpbmVyRWwpXG4gICAgICAgICAgICAuc2V0TmFtZSgnUXVhcnRvIFBhdGgnKVxuICAgICAgICAgICAgLnNldERlc2MoJ1BhdGggdG8gUXVhcnRvIGV4ZWN1dGFibGUgKGUuZy4sIHF1YXJ0bywgL3Vzci9sb2NhbC9iaW4vcXVhcnRvKScpXG4gICAgICAgICAgICAuYWRkVGV4dCh0ZXh0ID0+IHRleHRcbiAgICAgICAgICAgICAgICAuc2V0UGxhY2Vob2xkZXIoJ3F1YXJ0bycpXG4gICAgICAgICAgICAgICAgLnNldFZhbHVlKHRoaXMucGx1Z2luLnNldHRpbmdzLnF1YXJ0b1BhdGgpXG4gICAgICAgICAgICAgICAgLm9uQ2hhbmdlKGFzeW5jICh2YWx1ZSkgPT4ge1xuICAgICAgICAgICAgICAgICAgICB0aGlzLnBsdWdpbi5zZXR0aW5ncy5xdWFydG9QYXRoID0gdmFsdWU7XG4gICAgICAgICAgICAgICAgICAgIGF3YWl0IHRoaXMucGx1Z2luLnNhdmVTZXR0aW5ncygpO1xuICAgICAgICAgICAgICAgIH0pKTtcblxuICAgICAgICBuZXcgU2V0dGluZyhjb250YWluZXJFbClcbiAgICAgICAgICAgIC5zZXROYW1lKCdBdXRvIFByZXZpZXcnKVxuICAgICAgICAgICAgLnNldERlc2MoJ0F1dG9tYXRpY2FsbHkgc3RhcnQgcHJldmlldyB3aGVuIG9wZW5pbmcgUXVhcnRvIGZpbGVzJylcbiAgICAgICAgICAgIC5hZGRUb2dnbGUodG9nZ2xlID0+IHRvZ2dsZVxuICAgICAgICAgICAgICAgIC5zZXRWYWx1ZSh0aGlzLnBsdWdpbi5zZXR0aW5ncy5hdXRvUHJldmlldylcbiAgICAgICAgICAgICAgICAub25DaGFuZ2UoYXN5bmMgKHZhbHVlKSA9PiB7XG4gICAgICAgICAgICAgICAgICAgIHRoaXMucGx1Z2luLnNldHRpbmdzLmF1dG9QcmV2aWV3ID0gdmFsdWU7XG4gICAgICAgICAgICAgICAgICAgIGF3YWl0IHRoaXMucGx1Z2luLnNhdmVTZXR0aW5ncygpO1xuICAgICAgICAgICAgICAgIH0pKTtcblxuICAgICAgICBjb250YWluZXJFbC5jcmVhdGVFbCgnaDMnLCB7IHRleHQ6ICdVc2FnZScgfSk7XG4gICAgICAgIGNvbnN0IHVzYWdlVGV4dCA9IGNvbnRhaW5lckVsLmNyZWF0ZUVsKCdwJyk7XG4gICAgICAgIHVzYWdlVGV4dC5pbm5lckhUTUwgPSBgXG4gICAgICAgICAgICAtIFVzZSB0aGUgcmliYm9uIGljb24gb3IgY29tbWFuZCBwYWxldHRlIHRvIHRvZ2dsZSBwcmV2aWV3PGJyPlxuICAgICAgICAgICAgLSBDdHJsK1NoaWZ0K1AgdG8gcXVpY2tseSB0b2dnbGUgcHJldmlldzxicj5cbiAgICAgICAgICAgIC0gUHJldmlldyBVUkxzIHdpbGwgYmUgc2hvd24gaW4gbm90aWZpY2F0aW9uczxicj5cbiAgICAgICAgICAgIC0gQXV0by1wcmV2aWV3IGNhbiBiZSBlbmFibGVkIHRvIHN0YXJ0IHByZXZpZXcgYXV0b21hdGljYWxseVxuICAgICAgICBgO1xuICAgIH1cbn0iXSwibmFtZXMiOlsiUGx1Z2luIiwiTWFya2Rvd25WaWV3IiwiTm90aWNlIiwicGF0aCIsInNwYXduIiwiUGx1Z2luU2V0dGluZ1RhYiIsIlNldHRpbmciXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7QUFTQSxNQUFNLGdCQUFnQixHQUFzQjtJQUN4QyxVQUFVLEVBQUUsUUFBUTtBQUNwQixJQUFBLFdBQVcsRUFBRSxLQUFLO0NBQ3JCLENBQUE7QUFFb0IsTUFBQSxhQUFjLFNBQVFBLGVBQU0sQ0FBQTtBQUFqRCxJQUFBLFdBQUEsR0FBQTs7QUFFSSxRQUFBLElBQUEsQ0FBQSxzQkFBc0Is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
